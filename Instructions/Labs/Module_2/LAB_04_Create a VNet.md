---
lab:
    title: '实验室教学 4 - 创建一个 VNet'
    module: '模块 2 - 实施平台保护'
---

# 模块 2：实验室教学 4 - 创建一个 VNet


**场景**

在本模块中，你将了解到 Azure 虚拟网络。什么是虚拟网络，组织状态如何？如何使用模板、PowerShell、CLI 或 Azure 门户创建和配置虚拟网络？公共 IP、个人 IP，静态 IP 和动态 IP 地址之间有什么区别？如何使用系统路由、路由表和路由算法？课程包括：

- 介绍虚拟网络
- 创建 Azure 虚拟网络
- 查找 IP 地址


## 练习 1：使用 Azure 门户创建一个虚拟网络


**场景**

虚拟网络是 Azure 中专用网络的基本构建块。该网络使 Azure 资源（例如虚拟机 (VM)）彼此之间以及与网络之间实现安全通信。在本实验室教学中，你将学习如何使用 Azure 门户创建一个虚拟网络。然后，你可以将两个 VM 部署到虚拟网络中，在两个 VM 之间安全地通信，并通过网络连接到 VM。


### 任务 1：创建一个虚拟网络。

1.  在屏幕的左上角，选择**“创建一个资源”** > **“网络”** > **“虚拟网络”**。

1.  在**“创建虚拟网络”**中，输入或选择此信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入*“我的虚拟网络”*。 |
    | 地址空间 | 输入*“10.1.0.0/16”*。 |
    | 订阅 | 选择你的订阅。|
    | 资源组 | 选择**“新建”**，输入*“我的资源组”*，然后选择**“确认”**。 |
    | 位置 | 选择**“美国东部”**。|
    | 子网 — 名称 | 输入*“我的虚拟子网”*。 |
    | 子网 — 地址范围 | 输入*“10.1.0.0/24”*。 |

1.  保留其余默认值，然后选择**“创建”**。

### 任务 2：创建虚拟机


在虚拟网络中创建两个 VM：


1.  在屏幕的左上角，选择**“创建一个资源”** > **“计算”** > **“Windows 服务器 2019 数据中心”**。

1.  在**“创建一个虚拟机 — 基础”**中，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | **项目详情** | |
    | 订阅 | 选择你的订阅。 |
    | 资源组 | 选择**“我的资源组”**。你在上一节中已完成了创建。 |
    | **实例详情** |  |
    | 虚拟机名称 | 输入*“myVm1”*。 |
    | 区域 | 选择**“美国东部”**。 |
    | 可用性选项 | 保留默认的**“无需基础架构冗余”**。 |
    | 图像 | 保留默认的**“Windows 服务器 2019 数据中心”**。 |
    | 大小 | 保留默认的**“标准 DS1 v2”**。 |
    | **管理员帐户** |  |
    | 用户名 | 输入你选择的用户名。 |
    | 密码 | Pa55w.rd1234 |
    | 确认密码 | 重新输入密码。 |
    | **入栈端口规则** |  |
    | 公共入站端口 | 保留默认的**“无”**。 |
    | **节省资金** |  |
    | 已经拥有 Windows 许可证？ | 保留默认的**“否”**。 |

1.  选择**“下一步：”** **“磁盘”**。

1.  在**“创建虚拟机 — 磁盘”**中，保留默认值并选择**“下一步：”** **“网络”**。

1.  在**“创建虚拟机 — 网络”**中，选择此信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 虚拟网络 | 保留默认的**“我的虚拟网络”**。 |
    | 子网 | 保留默认的**“我的虚拟子网 (10.1.0.0/24)”**。 |
    | 公共 IP | 保留默认的**“(新) myVm-ip”**。 |
    | 公共入站端口 | 选择**“允许选定的端口”**。 |
    | 选择入站端口 | 选择**“HTTP”**和**“RDP”**。

1.  选择**“下一步：”** **“管理”**。

1.  在**“创建虚拟机 — 管理”**中，为**“诊断存储帐户”**，选择**“新建”**。

1.  在**“创建存储帐户”**中，输入或选择此信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入*“myvmstorageaccount”*。如果使用此名称，请创建一个唯一的名称。|
    | 帐户类型 | 保留默认的**“Storage（通用 v1）”**。 |
    | 性能 | 保留默认的**“标准”**。 |
    | 复制 | 保留默认的**“本地冗余存储 (LRS)”**。 |

1.  选择**“确定”**

1.  选择**“审阅 + 创建”**。你将进入**“审阅 + 创建”** 页面，在此，Azure 将验证你的配置。

1.  当你看到**“验证通过”**消息时，选择**“创建”**。

### 任务 3：  创建第二个 VM

1.  完成上面的步骤 1 至 9。

    **注**：在步骤 2 中，对于**“虚拟机名”**，输入*“myVm2”*。  在步骤 7 中，对于**“诊断存储帐户”**，请确保选择**“myvmstorageaccount”**。


1.  选择**“审阅 + 创建”**。你将进入**“审阅 + 创建”**页面，Azure 将验证你的配置。

1.  当你看到**“验证通过”**消息时，选择**“创建”**。

### 任务 4：  通过 Internet 连接到 VM


创建*“myVm1”*后，连接到网络。


1.  在门户网站搜索栏中，输入*“myVm1”*。

1.  单击**“连接”**按钮。


    选择**“连接”**按钮后，**“连接到虚拟机”**打开。

1.  单击**“下载 RDP 文件”**。Azure 会创建一个远程桌面协议 (*.rdp*) 文件并将其下载到你的计算机。

1.  打开下载的*“rdp”*文件。

    1. 如果出现提示，请选择**“连接”**。

    1. 输入创建 VM 时指定的用户名和密码。

    **注**：你需要选择**“更多选择”** > **“使用其他帐户”**，指定在创建 VM 时输入的凭证。


1.  选择**“确定”**。

1.  在登录过程中,你可能会收到证书警告。如果收到证书警告，请选择**“是”**或**“继续”**。

1.  出现 VM 桌面后，将其最小化以返回到本地桌面。

### 任务 5：在 VM 之间进行通信

1.  在*“myVm1”*的远程桌面中，打开 PowerShell。

1.  输入`ping myVm2`。

    你会收到类似的下列消息：

    ```powershell
    Pinging myVm2.0v0zze1s0uiedpvtxz5z0r0cxg.bx.internal.clouda
    Request timed out.
    Request timed out.
    Request timed out.
    Request timed out.

    Ping statistics for 10.1.0.5:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),
    ```

    `ping`失败，因为`ping`使用了网间控制报文协议 (ICMP)。默认情况下，ICMP 不允许通过 Windows 防火墙。

1.  在稍后的步骤中要允许*“myVm2”*到 ping*“myVm1”*，请输入以下命令：

    ```powershell
    New-NetFirewallRule -DisplayName "Allow ICMPv4-In" -Protocol ICMPv4
    ```

    此命令允许 ICMP 通过 Windows 防火墙入站：

1.  关闭到*“myVm1”*的远程桌面会话。

1.  完成上面再次显示的**“通过网络连接到 VM”**的步骤，但连接到*“myVm2”*。

1.  在命令提示符下，输入`ping myvm1` 。

    你会看到类似消息：

    ```powershell
    Pinging myVm1.0v0zze1s0uiedpvtxz5z0r0cxg.bx.internal.cloudapp.net [10.1.0.4] with 32 bytes of data:
    Reply from 10.1.0.4: bytes=32 time=1ms TTL=128
    Reply from 10.1.0.4: bytes=32 time<1ms TTL=128
    Reply from 10.1.0.4: bytes=32 time<1ms TTL=128
    Reply from 10.1.0.4: bytes=32 time<1ms TTL=128

    Ping statistics for 10.1.0.4:
        Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
    Approximate round trip times in milli-seconds:
        Minimum = 0ms, Maximum = 1ms, Average = 0ms
    ```

    你收到来自*“myVm1”*的回复，因为你在第 3 步骤中允许 ICMP 通过*“ myVm1”*VM 上的 Windows 防火墙。

1.  关闭到*“myVm2”*的远程桌面会话。


| 警告：在继续之前，你应该删除此实验室教学使用的所有资源。  为此，应在**“Azure 门户”**中，单击**“资源组”**。  选择你创建的任何资源组。  在资源组刀片服务器上，单击**“删除资源组”**，输入资源组名，然后单击**“删除”**。  对你创建的任何其他资源组重复该过程。**“否则可能会导致其他实验室教学出现问题”**。 |
| --- |

**“结果”**：现在你已经完成了本实验室教学。
