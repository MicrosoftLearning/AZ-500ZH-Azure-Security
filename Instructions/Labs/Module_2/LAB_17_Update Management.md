---
lab:
    title: '实验室教学 17 - 使用 Azure 自动化管理 Windows 更新'
    module: '模块 2 - 实施平台保护'
---

# 模块 2：实验室教学 17 - 使用 Azure 自动化管理 Windows 更新


**场景**

你可以使用更新管理解决方案管理虚拟机的更新和补丁。在本教程中，你将学习如何快速评估可用更新的状态、计划所需更新的安装、查看部署结果以及创建警报以验证更新是否成功应用。

## 练习 1：使用 Azure 自动化管理 Windows 更新。

### 任务 1：创建资源组

1.  单击 Azure 中心菜单上的**资源组**。

1.  单击**添加**。
1.  命名资源组为 **RunBooks**
1.  将区域更改为**美国东部**

### 任务 2：创建自动化帐户

1.  在 Azure 门户的左上角，单击**新建资源**按钮。

1.  选择**管理工具**，然后选择**自动化**。

1.  输入所需信息。

     |名称|资源组| 位置 | 按照帐户创建 Azure 运行
     |--------|--------|--------|--------|
     |MyAutomation|RunBooks|美国东部|是

1.  单击“创建”

1.  部署完成后，单击**所有服务**，选择**自动化帐户**并选择你创建的自动化帐户。

### 任务 3：创建要使用的 VM

1.  单击**虚拟机**

1.  单击**“添加”**

1.  填写以下详细信息，创建 VM


     |资源组|虚拟机名|区域|映像|用户名|密码|
     |--------|--------|------|-------------------|----------|------------|
     |RunBooks|UpdateVM|美国东部|Windows Server 2016|localadmin|Pa55w.rd1234|


1.  单击**审阅 + 创建**。

1.  单击**“创建”**

**注：**等待 VM 部署完成后再继续


### 任务 4：启用更新管理

1.  在门户中，单击虚拟机。

1.  选择你在上一步骤中创建的 VM。

1.  在**操作**中，单击**更新管理**

1.  单击**启用**

 执行验证，确定是否为此 VM 启用了更新管理。此验证包括检查 Azure 日志分析工作区和链接的自动化帐户，以及工作区中是否存在更新管理解决方案。

 日志分析工作区用于收集由功能和服务（例如更新管理）生成的数据。工作区提供了一个位置，可以查看并分析多个来源的数据。

 验证过程还将检查是否为 VM 配备了 Microsoft 监视代理程序 (MMA) 和自动混合 Runbook 辅助角色。该代理程序用于与 Azure 自动化通信并获取有关更新状态的信息。代理程序要求打开端口 443，以与 Azure 自动化服务进行通信并下载更新。

 如果在 VM 加入期间发现以下任何前提条件的缺失，则会自动添加它们：

  - **日志分析工作区**
  - **自动化帐户**
  - **混合 Runbook 辅助角色（在 VM 上启用）**
<br>

**注**：启用解决方案可能需要几分钟时间。在此期间，请勿关闭浏览器窗口。启用解决方案后，有关 VM 上缺少更新的信息将流向 Azure 监视日志。数据可能需要 30 分钟到 6 个小时才能用于分析。


### 任务 5：查看更新评估

1.  启用更新管理后，将打开**更新管理**窗格

1.  如果缺少更新，将在此处显示

    **注**：如果你是根据上述步骤创建的 VM，则这是 Microsoft 的模板VM，其中包含所有最新的 Windows 更新，因此你可能看不到该 VM 的任何必要更新


1.  如果有可用更新，将通过“信息链接”列下的一个链接列出相关更新，你可以通过该链接查看更新详情，同时链接到 Microsoft 的更新 Kb 文章。

### 任务 6：配置警报

1.  返回你之前创建的资源组

1.  选择 **MyAutomation** 自动化帐户

1.  在**监控**中，单击**警报** 

1.  单击**新警报规则**

1.  单击**添加条件**

1.  在列表中选择**总更新部署运行**

1.  单击 **Runbook 名**和**状态**旁边的**选择复选框**

1.  在**警报逻辑**中，对于**阈值**，输入 **1**

1.  单击完成 

1.  在**警报详情**中，填写**警报规则名**为**UpdateAlert**

1.  将严重程度设置为 **Sev2**

1.  在**操作组**中，选择**新建**

1.  填写以下详细信息 

     |操作组名| 简称|资源组| 操作名|操作类型|
     |-----------------|-----------|------------|------------|-----------|
     |VM 更新操作组|VMup|Runbooks|电子邮件|电子邮件/短信/推送/语音


1.  在电子邮件旁边单击**编辑详情**，填写**你的邮件**用于警报

1.  单击**确定**。

1.  在操作组下单击**选择现有**

1.  选择你的操作组

1.  单击**“创建”** 

### 任务 7：安排更新部署

1.  返回 VM 列表

1.  选择你在实验室教学中创建的 VM

1.  单击更新管理

1.  选择时间表更新部署

1.  在新的计划更新部署中，填写以下设置

      - **名称** - 计划更新 
      - **时间表设定** -  Recurance > reccuring

1.  单击**确定**，然后单击**创建**

1.  单击**部署时间表**，查看活动列表**部署时间表**

### 任务 8：查看更新部署的结果


**注**：计划部署开始后，你可以在更新管理下的“更新部署”选项卡上查看该部署的状态。当前正在运行部署时，状态为进行中。部署完成后，如果成功，状态将更改为成功。如果部署中的一个或多个更新失败，则状态为部分失败。


| 警告：在继续之前，你应该删除此实验室教学使用的所有资源。  为此，应在**“Azure 门户”**中，单击**“资源组”**。  选择你创建的任何资源组。  在资源组边栏选项卡上，单击**删除资源组**，输入资源组名称，然后单击**删除**。  对你创建的任何其他资源组重复该过程。**否则可能会导致其他实验室出现问题。** |
| --- |


**“结果”**：现在，你已经为在 Azure 中运行 Windows 服务器 VM 的警报系统添加了计划 Windows 更新管理

