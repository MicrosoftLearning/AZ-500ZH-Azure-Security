---
lab:
    title: '实验 3 - 事件中心'
    module: '模块 3：管理安全操作'
---

# 模块 3：实验 3 - 事件中心


将发送和接收应用程序与事件中心连接起来，以便你可以处理极高的负载而不会丢失数据。

在本实验中，你将：

- 使用 Azure 门户创建事件中心
- 配置应用程序以通过事件中心发送或接收消息
- 使用 Azure 门户评估事件中心性能

## 练习 1：实现事件中心

### 任务 1：启用事件中心命名空间

1.  登录 Azure 门户

2.  在搜索栏中输入**“事件中心”**，然后选择**“事件中心”**

3.  请单击**“添加”**以添加新事件中心命名空间

  - 使用以下详细信息填充字段：

     - **“名称”**：你的唯一名称
     - **“定价层”**：标准版
     - **“订阅”**：你的订阅
     - **资源组**：创建名为“EventHubRG”的新资源组
     - **位置**：美国东部
     - **“吞吐量单位”**：2

4.  单击**“创建”**

### 任务 2：为以后的用户创建一个存储帐户


**注**：我们还需要创建一个存储帐户和一个 Blob 存储容器来存储将在以后发送到事件中心的事件


1.  在搜索栏中搜索**“存储帐户”**，然后单击**“存储帐户”**

2.  单击**“添加”**。
3.  选择的**“EventHubsRG”**资源组（如果你选择使用另一个资源组，则为该资源组的名称）
4.  配置以下选项：

      - **“存储帐户名称”**：唯一名称（在整个 azure 中均唯一）
      - **“位置”**：美国东部
      - **性能**：标准版
      - **“帐户类型”**：通用 v2
      - **复制**：本地冗余存储 (LRS)
      - **访问层**：热

5.  请单击**“查看+创建”**，然后单击**“创建”**

6.  等待存储帐户以进行**“创建”**
7.  返回存储帐户。
8.  选择你创建的存储帐户
9.  在概述窗格中，单击**“Blob”**
10.  请单击**“+容器”**
11.  对于名称，输入**“事件”**
12.  设置**“容器的公共访问级别”**
13.  单击“确定”

### 任务 3：创建新事件中心

1.  返回事件中心，单击新创建的事件中心命名空间的名称

2.  在事件中心命名空间中，单击选择窗格中“实体”下方的**“事件中心”**

3.  单击**“+事件中心”**

4.  输入“事件”的名称

5.  请单击**“捕获”**下方的**“打开”**

    **注**：这将打开将事件转储到我们以前创建的 Blob 存储的功能


6.  单击选择**“容器”**

7.  选择**“以前创建的存储帐户名”**

8.  选择**“以前创建的 Blob 存储名”**

9.  单击**“选择”**

10.  单击**“创建”**

### 任务 4：收集数据以便能够将事件发送到事件中心

1.  在事件中心命名空间下，单击**“共享访问策略”**

2.  单击**“RootManageSharedAccessKey”**

3.  单击主密钥旁边的“复制到剪贴板”图标

4.  打开记事本并将其粘贴到那里以备后用 

5.  将事件中心命名空间的名称和你创建的事件中心的名称复制到同一记事本文档中

**注**：你将需要此主密钥和脚本的其他信息，这些脚本将在以后运行以将一些数据输入事件中心系统中


### 任务 5：下载脚本文件


现在，我们将下载脚本，该脚本将用于创建一些要发送到事件中心的事件，这将模拟事件中心从编写环境中的应用程序接收数据，以与事件中心通信或从其他与 Azure 事件中心通信的系统进行通信。脚本文件由 godeploy 开发并发布在 PowerShell 库中


1.  以管理员身份打开**“PowerShell”** （右击 PowerShell 图标）并运行以下命令

     ```powershell
    install-script get-blobevents, send-blobevents
     ```

**注**：如果出现提示，请确认安装。脚本文件现已下载，可以在 PowerShell 中使用


### 任务 6：将一些事件发送到事件中心


对于此部分，你将需要从以前的门户复制主密钥


1.  打开 PowerShell

2.  运行以下命令： 

     ```powershell
    send-blobevents
     ```

3.  该命令将提示你输入以下数据：

      - **“primaryKey”**：        以前就在实验中复制了你的主密钥
      - **“eventhubnamespace”**：命名空间的名称
      - **“eventhub”**：          事件中心的名称
      - **“numberOfEvents”**：    10（你可以选择更多，但发送到事件中心的时间会更长）
  

如果你收到一系列**“401未经授权的错误”**，则从脚本中检查执行代码的机器上的时钟，如果使用 Godeploy 机器，则应将其设置为 UTC。如果已更正时间，则需要重新启动 PowerShell 的外壳程序并重新运行代码。


**注**：这会将带有随机数据的一系列事件发送到事件中心


### 任务 7：查看事件中心和 Blob 存储中的事件

1.  返回事件中心和你的**“事件中心命名空间”**

2.  请单击**“事件中心”**，然后选择**“事件中心”**

3.  在概述窗格中，查看“事件中心”图，以查看传入消息的数据峰值

4.  搜索并打开**“存储帐户”**

5.  选择你的**“事件中心存储帐户”**

6.  请单击**“Blob”**

7.  打开你用于事件存储**“Blob 容器”**

**“信息”**：在这里，你可以查看由事件中心系统创建的原始 .avro 事件，有关事件中心使用的 .avro 格式的更多信息，请参见以下 Wiki 文章 **`https://en.wikipedia.org/wiki/Apache_Avro`**


### 任务 8：查看从 REST 查询到 Blob 存储的事件

1.  启动**“PowerShell”**

2.  运行**“get-blobevents”**并在出现提示时输入以下内容：

  - **“blobName”**：存储帐户的名称
  - **“containterName”**：存储事件的 Blob 容器的名称
</br>

**注**：你可以在存储帐户中看到此信息。该脚本将对 Blob 存储进行 REST 查询，以列出存储 Blob 中的所有 .avro 事件。

| 警告：在继续之前，你应该删除此实验室教学使用的所有资源。  为此，应在**“Azure 门户”**中，单击**“资源组”**。  选择你创建的任何资源组。  在资源组边栏选项卡上，单击**删除资源组**，输入资源组名称，然后单击**删除**。  对你创建的任何其他资源组重复该过程。**否则可能会导致其他实验室出现问题。** |
| --- |


**“结果”**：你现在已经完成了本实验，可以继续进行本系列的下一个实验

